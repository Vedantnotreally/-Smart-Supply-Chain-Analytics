--  the Main Transaction Table
SELECT TOP 1000 * FROM Fact_Supply_Chain

--   the Customer List
SELECT TOP 100 * FROM Dim_Customers

-- the Product List
SELECT TOP 100 * FROM Dim_Products

SELECT COUNT(*)  [Total_Orders] FROM Fact_Supply_Chain

--all unique ways we ship products.
SELECT DISTINCT shipping_mode_encoded FROM Fact_Supply_Chain

--only the big mistakes (High Late Risk).
SELECT * FROM Fact_Supply_Chain
WHERE late_delivery_risk = 1

--the biggest spenders:
SELECT TOP 10 * FROM Fact_Supply_Chain
ORDER BY sales DESC

--What is the average distance of a delivery?
SELECT 
    AVG(delivery_distance_km)  [Avg_Distance],
    MAX(delivery_distance_km)   [Max_Distance],
    MIN(delivery_distance_km)  [Min_Distance]
FROM Fact_Supply_Chain;

--Which Region buys the most?
SELECT order_region, SUM(sales) [Total_Revenue]
FROM Fact_Supply_Chain
GROUP BY order_region
ORDER BY Total_Revenue DESC

--How many orders did we have in 2016 vs 2017?
SELECT YEAR(order_date_dateorders) AS Order_Year, COUNT(order_id) AS Total_Orders
FROM Fact_Supply_Chain
GROUP BY YEAR(order_date_dateorders)
ORDER BY Order_Year

--Wildcard Search:Find all customers named smith:
SELECT * FROM Dim_Customers
WHERE customer_lname LIKE 'Smith%'

--Null Check: Are there any orders with missing customer IDs?

SELECT COUNT(*) [NullRows ]
FROM Fact_Supply_Chain 
WHERE customer_id IS NULL

--Creating a new category:
SELECT order_id, sales,
CASE 
    WHEN sales > 500 THEN 'High Value'
    WHEN sales > 200 THEN 'Medium Value'
    ELSE 'Low Value'
END AS Order_Category
FROM Fact_Supply_Chain

--Showing the Product Name and Customer Name for every Late Order
SELECT TOP 50
    c.customer_fname, 
    c.customer_lname, 
    p.product_name, 
    f.late_delivery_risk
FROM Fact_Supply_Chain f
JOIN Dim_Customers c ON f.customer_id = c.customer_id
JOIN Dim_Products p ON f.product_card_id = p.product_card_id
WHERE f.late_delivery_risk = 1;

--Bottleneck Analysis:Which Shipping Mode is the worst? (High Risk + Long Distance):
SELECT 
    shipping_mode_encoded, 
    COUNT(order_id) AS Total_Shipments, 
    AVG(late_delivery_risk) * 100  [Late_Risk_Percentage],
    AVG(delivery_distance_km)  [Avg_Distance_KM]
FROM Fact_Supply_Chain
GROUP BY shipping_mode_encoded
ORDER BY Late_Risk_Percentage DESC

--Ranking the  Top 3 most sold products in EACH Region(window function):
SELECT * FROM (
    SELECT 
        order_region,
        product_card_id,
        SUM(sales) AS Total_Sales,
        RANK() OVER(PARTITION BY order_region ORDER BY SUM(sales) DESC) as Rank_In_Region
    FROM Fact_Supply_Chain
    GROUP BY order_region, product_card_id
) Ranked_Table
WHERE Rank_In_Region <= 3

--Running Total:Watching  revenue grow order by order:
SELECT 
    order_date_dateorders,
    sales,
    SUM(sales) OVER(ORDER BY order_date_dateorders ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS Cumulative_Revenue
FROM Fact_Supply_Chain;

--Segmentation:finding  "VIP Customers" (Spent > $5000) and check if they are happy (Low Late Risk) (CTE):
WITH Customer_Stats AS (
    SELECT 
        customer_id, 
        SUM(sales) [Total_Spent],
        AVG(late_delivery_risk) AS Avg_Risk
    FROM Fact_Supply_Chain
    GROUP BY customer_id
)
SELECT 
    c.customer_fname, 
    cs.Total_Spent, 
    cs.Avg_Risk
FROM Customer_Stats cs
JOIN Dim_Customers c ON cs.customer_id = c.customer_id
WHERE cs.Total_Spent > 5000
ORDER BY cs.Total_Spent DESC

--Gap Analysis:Find all orders that were MORE expensive than the average order value.
SELECT order_id, sales
FROM Fact_Supply_Chain
WHERE sales > (SELECT AVG(sales) FROM Fact_Supply_Chain)

--Customer Churn Risk: Customers who have had 3 or more late deliveries are likely to quit.

SELECT 
    customer_id, 
    COUNT(order_id) AS Total_Orders,
    SUM(late_delivery_risk) [Total_Late_Deliveries]
FROM Fact_Supply_Chain
GROUP BY customer_id
HAVING SUM(late_delivery_risk) >= 3
ORDER BY Total_Late_Deliveries DESC

--Product Profitability:Which product category is driving the most revenue vs risk?
SELECT 
    p.category_name,
    SUM(f.sales)  [Revenue],
    SUM(f.late_delivery_risk)  [Late_Orders]
FROM Fact_Supply_Chain f
JOIN Dim_Products p ON f.product_card_id = p.product_card_id
GROUP BY p.category_name
ORDER BY Revenue DESC;

